@using VanPhongPhamDKT.Models
@model SanPham

@{
    ViewData["Title"] = "Sửa sản phẩm";
    Layout = "~/Views/Shared/_Layout.cshtml";

    string Src(string? p) => string.IsNullOrWhiteSpace(p)
        ? Url.Content("~/assets/img/placeholder-300x300.png")
        : (p.StartsWith("http", StringComparison.OrdinalIgnoreCase) ? p : Url.Content(p));
}

<link rel="stylesheet" href="~/css/sanpham.css" asp-append-version="true" />
<div class="site-bg--sanpham"></div>

<div class="sp-edit-page container mt-4">
    <h2 class="sp-title text-warning mb-3"><i class="fa-solid fa-pen"></i> Sửa sản phẩm</h2>

    <form asp-action="Edit" method="post" enctype="multipart/form-data"
          class="sp-form-glass sp-form-glass--edit">
        @Html.AntiForgeryToken()

        <!-- khóa chính & path ảnh cũ -->
        <input type="hidden" asp-for="MaSp" />
        <input type="hidden" asp-for="HinhAnh" />

        <div asp-validation-summary="ModelOnly" class="sp-form-error mb-2"></div>

        <!-- Cột trái: Preview + chọn ảnh -->
        <div class="sp-edit-left">
            <div class="sp-image-preview large">
                <img id="preview" src="@Src(Model.HinhAnh)" alt="@Model.TenSp" />
            </div>

            <div class="mt-3">
                <label class="form-label">Chọn ảnh mới (tùy chọn)</label>
                <input type="file" name="HinhAnhFile" class="form-control" accept="image/*" id="spImageInputEdit" />
                <span class="sp-field-note d-block mt-1">Để trống nếu muốn giữ ảnh cũ.</span>
                <span class="text-danger">@ViewBag.FileError</span>
            </div>
        </div>

        <!-- Cột phải: các trường -->
        <div class="sp-edit-right">
            <div class="mb-3">
                <label asp-for="TenSp" class="form-label"></label>
                <input asp-for="TenSp" class="form-control" />
                <span asp-validation-for="TenSp" class="sp-field-error"></span>
            </div>

            <div class="mb-3">
                <label asp-for="Gia" class="form-label"></label>
                <input asp-for="Gia" class="form-control" type="number" />
                <span asp-validation-for="Gia" class="sp-field-error"></span>
            </div>

            <div class="mb-3">
                <label asp-for="SoLuong" class="form-label"></label>
                <input asp-for="SoLuong" class="form-control" type="number" min="0" />
                <span asp-validation-for="SoLuong" class="sp-field-error"></span>
            </div>

            <div class="mb-3">
                <label asp-for="MaDm" class="form-label"></label>
                <select asp-for="MaDm" asp-items="ViewBag.MaDm" class="form-select" required>
                    <option value="">-- Chọn danh mục --</option>
                </select>
                <span asp-validation-for="MaDm" class="sp-field-error"></span>
            </div>

            <div class="mb-3 sp-col-full">
                <label asp-for="MoTa" class="form-label"></label>
                <textarea asp-for="MoTa" class="form-control" rows="4"></textarea>
                <span asp-validation-for="MoTa" class="sp-field-error"></span>
            </div>
        </div>

        <!-- Actions -->
        <div class="sp-actions">
            <button type="submit" class="btn sp-btn-primary">
                <i class="fa-solid fa-save"></i> Cập nhật
            </button>
            <a asp-area="admins" asp-controller="SanPham" asp-action="Index" class="btn sp-btn-cancel">← Quay lại</a>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Preview ảnh mới khi chọn
        const input = document.getElementById('spImageInputEdit');
        const img = document.getElementById('preview');
        if (input && img) {
            input.addEventListener('change', e => {
                const f = e.target.files?.[0];
                if (!f) return;
                const url = URL.createObjectURL(f);
                img.src = url;
                img.onload = () => URL.revokeObjectURL(url);
            });
        }
    </script>
}