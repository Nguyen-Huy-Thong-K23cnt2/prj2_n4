@model VanPhongPhamDKT.Models.DonHang
@{
    Layout = null; /* nếu muốn dùng layout chung, thay = "~/Views/Shared/_Layout.cshtml" */
    var title = $"Sửa đơn hàng #{Model?.MaDh}";
    string? ngayDatValue = Model?.NgayDat.HasValue == true
        ? Model.NgayDat.Value.ToString("yyyy-MM-ddTHH:mm")
        : null;

    var statuses = new[] { "Mới", "Chờ duyệt", "Đang giao", "Hoàn tất", "Đã hủy" };
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

    <div class="container my-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2 class="fw-bold text-primary mb-0">@title</h2>
                <small class="text-muted">Cập nhật thông tin cơ bản của đơn hàng</small>
            </div>
            <a asp-action="Index" class="btn btn-outline-secondary">
                ← Quay lại danh sách
            </a>
        </div>

        <div class="row g-4">
            <!-- Form -->
            <div class="col-lg-8">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <!-- QUAN TRỌNG: asp-route-id để khớp Edit(int id) -->
                        <form asp-action="Edit"
                              asp-route-id="@Model.MaDh"
                              method="post"
                              class="needs-validation" novalidate>
                            @Html.AntiForgeryToken() <!-- ✅ BỔ SUNG TOKEN -->

                            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                            <input asp-for="MaDh" type="hidden" />

                            <!-- Khách hàng -->
                            <div class="mb-3">
                                <label asp-for="MaKh" class="form-label fw-semibold">Khách hàng</label>
                                <select asp-for="MaKh" class="form-select" asp-items="ViewBag.MaKh" required>
                                    <option value="">-- Chọn khách hàng --</option>
                                </select>
                                <span asp-validation-for="MaKh" class="text-danger"></span>
                            </div>

                            <!-- Ngày đặt -->
                            <div class="mb-3">
                                <label asp-for="NgayDat" class="form-label fw-semibold">Ngày đặt</label>
                                <!-- name="NgayDat" để controller cách 2 đọc Request.Form -->
                                <input type="datetime-local"
                                       name="NgayDat"
                                       class="form-control"
                                       value="@ngayDatValue" />
                                <span asp-validation-for="NgayDat" class="text-danger"></span>
                            </div>

                            <!-- Tổng tiền -->
                            <div class="mb-3">
                                <label asp-for="TongTien" class="form-label fw-semibold">Tổng tiền</label>
                                <div class="input-group">
                                    <input asp-for="TongTien" type="number" step="1" inputmode="numeric" class="form-control" asp-format="{0:0}"  />
                                    <span class="input-group-text">đ</span>
                                </div>
                                <span asp-validation-for="TongTien" class="text-danger"></span>
                                <div class="form-text">Giá trị phải &gt; 0.</div>
                            </div>

                            <!-- Trạng thái -->
                            <div class="mb-4">
                                <label asp-for="TrangThai" class="form-label fw-semibold">Trạng thái</label>
                                <select asp-for="TrangThai" class="form-select">
                                    <option value="">-- Chọn trạng thái --</option>
                                    @foreach (var s in statuses)
                                    {
                                        <option value="@s" selected="@(string.Equals(Model?.TrangThai, s, StringComparison.OrdinalIgnoreCase))">@s</option>
                                    }
                                </select>
                                <span asp-validation-for="TrangThai" class="text-danger"></span>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    Lưu thay đổi
                                </button>
                                <a asp-action="Index" class="btn btn-outline-secondary">Hủy</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Ghi chú -->
            <div class="col-lg-4">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="fw-bold mb-3">Ghi chú</h5>
                        <ul class="small text-muted ps-3 mb-0">
                            <li>Chọn đúng khách hàng trước khi lưu.</li>
                            <li>Trạng thái theo quy trình: Mới → Chờ duyệt → Đang giao → Hoàn tất.</li>
                            <li>Tổng tiền phải lớn hơn 0.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @await Html.PartialAsync("_ValidationScriptsPartial")

    <style>
        .card {
            border-radius: .75rem;
        }

        .form-label {
            margin-bottom: .35rem;
        }
    </style>

    <script>
        (() => {
            'use strict';
            const forms = document.querySelectorAll('.needs-validation');
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', e => {
                    if (!form.checkValidity()) { e.preventDefault(); e.stopPropagation(); }
                    form.classList.add('was-validated');
                }, false);
            });
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
