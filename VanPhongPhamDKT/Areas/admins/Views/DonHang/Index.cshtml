@model IEnumerable<VanPhongPhamDKT.Models.DonHang>
@using System.Globalization

@{
    Layout = "~/Views/Shared/_Layout.cshtml";

    // Hàm nhỏ để map màu theo trạng thái
    string BadgeClass(string? status)
    {
        var s = (status ?? "").Trim().ToLowerInvariant();
        return s switch
        {
            "mới" or "chó duyệt" or "chờ duyệt" => "warning",
            "đang giao" => "info",
            "hoàn tất" => "success",
            "đã hủy" or "da huy" or "hủy" => "secondary",
            _ => "dark"
        };
    }

    string Vnd(decimal money) => string.Format(CultureInfo.GetCultureInfo("vi-VN"), "{0:N0} đ", money);
}

<link rel="stylesheet" href="~/css/donhang.css" asp-append-version="true" />
<div class="site-bg--donhang"></div>

<div class="container mt-4 dh-page">

    <!-- Alerts -->
    @if (TempData["Success"] is string ok && !string.IsNullOrWhiteSpace(ok))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle me-2"></i>@ok
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] is string err && !string.IsNullOrWhiteSpace(err))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>@err
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="dh-title mb-0">Quản lý đơn hàng</h2>
            <small class="dh-sub">Theo dõi, chỉnh sửa và xử lý các đơn đặt hàng</small>
        </div>
    </div>

    <!-- Bảng -->
    <div class="card shadow-sm border-0 dh-card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 dh-table">
                    <thead class="table-dark text-center">
                        <tr>
                            <th style="width:110px;">Mã đơn</th>
                            <th style="width:140px;">Ngày đặt</th>
                            <th class="text-end" style="width:160px;">Tổng tiền</th>
                            <th style="width:140px;">Trạng thái</th>
                            <th>Khách hàng</th>
                            <th style="width:220px;">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model == null || !Model.Any())
                        {
                            <tr>
                                <td colspan="6" class="text-center py-4 text-muted">
                                    Chưa có đơn hàng nào.
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var item in Model.OrderByDescending(x => x.NgayDat))
                            {
                                var khTen = item.MaKhNavigation?.HoTen;
                                var khEmail = item.MaKhNavigation?.Email;
                                var khHienThi = !string.IsNullOrWhiteSpace(khTen) ? khTen
                                : (!string.IsNullOrWhiteSpace(khEmail) ? khEmail : $"KH#{item.MaKh}");

                                <tr class="text-center">
                                    <td class="fw-semibold">#@item.MaDh</td>
                                    <td>@(item.NgayDat?.ToString("dd/MM/yyyy HH:mm") ?? "—")</td>
                                    <td class="text-end">@Vnd(item.TongTien)</td>
                                    <td>
                                        <span class="badge bg-@BadgeClass(item.TrangThai) px-3 py-2">
                                            @(!string.IsNullOrWhiteSpace(item.TrangThai) ? item.TrangThai : "—")
                                        </span>
                                    </td>
                                    <td class="text-start">
                                        @khHienThi
                                    </td>
                                    <td>
                                        <div class="d-flex justify-content-center gap-2">
                                            <a asp-action="Details" asp-route-id="@item.MaDh" class="btn btn-sm btn-outline-secondary">
                                                <i class="bi bi-eye"></i> Chi tiết
                                            </a>
                                            <a asp-action="Edit" asp-route-id="@item.MaDh" class="btn btn-sm btn-primary">
                                                <i class="bi bi-pencil-square"></i> Sửa
                                            </a>
                                            <a asp-action="Delete" asp-route-id="@item.MaDh"
                                               class="btn btn-sm btn-danger"
                                               onclick="return confirm('Xoá đơn #@item.MaDh? Hành động này không thể hoàn tác.');">
                                                <i class="bi bi-trash3"></i> Xoá
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Footer actions -->
    <div class="mt-3">
        <a asp-area="admins" asp-controller="Dashboard" asp-action="Index" class="dh-back">
            ⬅ Quay về trang chủ
        </a>
    </div>
</div>